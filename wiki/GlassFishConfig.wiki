#summary Replacing GlassFish Self-Signed Certificate.
#labels Icat-Security


= Replacing !GlassFish Self-Signed Certificate =

Author: Shirley Crompton[[BR]]

Date:   2 September, 2008[[BR]]


== Introduction  ==

The GlassFish default installation uses a self-signed server certificate to support SSL.  You may wish to replace this with a host certificate signed by the UK eScience CA.

== Prerequisites  ==
1.  Obtain a host certificate for the server.  The common name must match the fully qualified name of your server (eg. myMachine.dl.ac.uk).[[BR]]

2.  Also download the UK eScience CA and UK eScience Root certificates from the [http://www.grid-support.ac.uk/content/view/182/244/ NGS website][[BR]]

3.  Download the pkcs12import utility from [https://xwss.dev.java.net/servlets/ProjectDocumentList?folderID=6645&expandFolder=6645&folderID=6645) Project Metro].[[BR]]

4.  Install the pkcs12import utility.  You will need to adjust the paths in the provided pkcs12import.bat file.[[BR]]

5.  Basic knowledge of [http://java.sun.com/javase/6/docs/technotes/tools/solaris/keytool.html Java Keytool].[[BR]]

6.  Optional for ICAT-api, experience of [wiki:CogkitConfig configuring Java CogKit].[[BR]]



== Prepare the Server Certificate (based on IE)  ==
1.  Import the signed certificate into your browser.[[BR]]

2.  Export it as a pfx file.  Select options to include private key, all certificates and enable strong encryption.[[BR]]

3.  Use the GlassFish default keystore password for the export passphrase.  If you are using your own keystore password, ''you will need to configure the keyStorePassword JVM option in !GlassFish'' (see Procedures step 7 below).[[BR]]

4.  Use openssl to extract the server certificate and private key into separate pem files. [[BR]]

5.  Use a text editor to edit the server certificate pem file to remove the ascii headers.  Your file should start and end with[[BR]]

{{{
-----BEGIN CERTIFICATE----- 
contents
-----END CERTIFICATE-----
}}}



== Procedures  ==
1.  Go to 'GlassFish_Home'/domains/'your_domain'/config folder.[[BR]]

2.  Backup the existing GlassFish keystore and truststore jks files. [[BR]]

3.  Remove the self-signed certificate from the keystore and the truststore.[[BR]]

{{{
keytool -delete -alias s1as -keystore <store>.jks -storepass <store_pswd>
}}}

4.  Load the public certificates (server, CA, CA Root) into the truststore.  Use the same alias (s1as) for the server certificate.[[BR]]

{{{
keytool -importcert -alias <alias> -file <yourfile.pem> -storepass <store_pswd> -trustcacerts -keystore <truststore>.jks
}}}

5.  Use the pkcs12import utilty to load the server certificate (pfx file) into the keystore.  Use the s1as alias for the entry.[[BR]]

{{{
pkcs12import.bat -file <server.pfx> -alias s1as -storepass <store_pswd> -keystore keystore.jks -pass <passphrase>
}}}

6.  Use the keytool -list option to check the entries in both stores.  Compare the server certificate fingerprints in both stores.  They should match.[[BR]]

7.  Optional step - if you are using your own keystore password, you must configure the GlassFish JVM options.[[BR]]

* Start the Admin Console.[[BR]]
* Select the Application Server in the Admin Console Tree.[[BR]]
* Select the JVM Options tab.[[BR]]
* Add this JVM Option:[[BR]]

{{{
-Djavax.net.ssl.keyStorePassword=<your_password>
}}}

8.  Re-start the application server.[[BR]]

9.  Distribute the {{{<truststore>}}}.jks to SSL client applications.[[BR]]

 
== Additional Configuration for ICAT-API ==

1.  [wiki:CogkitConfig Configure Cog-kit] to use the new server certificate and private key.[[BR]]

2.  Update the ICAT pass properties file.[[BR]]